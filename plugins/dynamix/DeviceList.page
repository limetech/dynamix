Menu="Shares:2"
Title="Device Shares"
---
<?PHP
/* Copyright 2015, Lime Technology
 * Copyright 2015, Bergware International.
 *
 * This program is free software; you can redistribute it and/or
 * modify it under the terms of the GNU General Public License version 2,
 * as published by the Free Software Foundation.
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 */
?>

<?
// User share data exists only if array is Started
if ($var['fsState']!="Started") {
  echo "<p class='notice'>Array must be <strong><big>started</big></strong> to view Device Shares.</p>";
  return;
}
// Display export settings
function disk_share_settings($protocol,$share) {
  if (empty($share)) return;
  if ($protocol!='yes' || $share['export']=='-') return "-";
  if ($share['export']=='e') return ucfirst($share['security']);
  return '<em>'.ucfirst($share['security']).'</em>';
}
// Share size per disk
$preserve = $path==$prev;
$ssz2 = array();
foreach (glob("state/*.ssz2", GLOB_NOSORT) as $entry) {
  if ($preserve) {
    $ssz2[basename($entry, ".ssz2")] = parse_ini_file($entry);
  } else {
    unlink($entry);
  }
}
?>
<script>
$(function() {
  if (window.innerWidth>1590) $('span.disks').addClass('left');
});
</script>

<table class="share_status share <?=$display['view']?>">
<thead><tr><td style="width:15%">Name</td><td style="width:33%">Identity</td><td>SMB</td><td>NFS</td><td>AFP</td><td>Size</td><td>Free</td><td>View</td></tr></thead>
<tbody>
<?
foreach ($disks as $disk):
  $name = $disk['name'];
  $device = my_disk($name);
  $color = $disk['color'];
  $id = $disk['id'];
  if ($disk['type']=='Parity') continue;
?><tr>
<?switch ($disk['type']):
  case 'Data':
?><td><a href="#" class="info nohand" onclick="return false">
  <img src="/webGui/images/<?=$color?>.png" class="icon"><span class="disks">
  <img src="/webGui/images/green-on.png" class="icon">Normal operation<br>
  <img src="/webGui/images/yellow-on.png" class="icon">Data in reconstruction<br>
  <img src="/webGui/images/red-off.png" class="icon">Device disabled<br>
  <img src="/webGui/images/blue-on.png" class="icon">New device not in array<br>
  <img src="/webGui/images/green-blink.png" class="icon">Device spun-down<br>
  </span></a><a href="<?=$path?>/Disk?name=<?=$name?>" onclick="$.cookie('one','tab1',{path:'/'})"><?=$device?></a></td>
<?break;
  case 'Cache':
?><td><a href="#" class="info nohand" onclick="return false">
  <img src="/webGui/images/<?=$color?>.png" class="icon"><span class="disks">
  <img src="/webGui/images/green-on.png" class="icon">Normal operation<br>
  <img src="/webGui/images/blue-on.png" class="icon">New device not in pool<br>
  <img src="/webGui/images/green-blink.png" class="icon">Device spun-down<br>
  </span></a><a href="<?=$path?>/Disk?name=<?=$name?>" onclick="$.cookie('one','tab1',{path:'/'})"><?=$device?></a></td>
<?break;
  case 'Flash':
?><td><img src="/webGui/images/green-on.png" class="icon">
  <a href="<?=$path?>/Disk?name=<?=$name?>" onclick="$.cookie('one','tab1',{path:'/'})"><?=$device?></a></td>
<?break;
  endswitch;
?><td><?=$id?></td>
  <td><?=disk_share_settings($var['shareSMBEnabled'], $sec[$name])?></td>
  <td><?=disk_share_settings($var['shareNFSEnabled'], $sec_nfs[$name])?></td>
  <td><?=disk_share_settings($var['shareAFPEnabled'], $sec_afp[$name])?></td>
<?if (array_key_exists($name, $ssz2)):?>
  <td><?=my_scale(($disk['size']-$disk['fsFree'])*1024, $unit).' '.$unit?></td>
  <td><?=my_scale($disk['fsFree']*1024, $unit).' '.$unit?></td>
  <td><a href="<?=$path?>/Browse?dir=/mnt/<?=$name?>"><img src="/webGui/images/explore.png" title="Browse /mnt/<?=$name?>"></a></td>
  </tr>
<?foreach ($ssz2[$name] as $share_name => $share_size):
    if ($share_name!="total"):
?>  <tr class="share_status_size">
    <td><?=$share_name?>:</td>
    <td></td>
	  <td></td>
	  <td></td>
    <td></td>
    <td><?=my_scale($share_size*1024, $unit).' '.$unit?></td>
    <td><?=my_scale($disk['fsFree']*1024, $unit).' '.$unit?></td>
    <td></td>
    </tr>
<?  endif;
  endforeach;
  else:
  $cmd="$docroot/webGui/scripts/disk_size $name /var/local/emhttp/$name.ssz2";
?><td><a href="/update.htm?cmd=<?=$cmd?>&runCmd=Start" target="progressFrame">Compute...</a></td>
  <td><?=my_scale($disk['fsFree']*1024, $unit).' '.$unit?></td>
  <td><a href="<?=$path?>/Browse?dir=/mnt/<?=$name?>"><img src="/webGui/images/explore.png" title="Browse /mnt/<?=$name?>"></a></td>
  </tr>
<?endif;
endforeach;
?>
</tbody>
</table>

> Shares displayed in *italic* are exported as hidden shares.
